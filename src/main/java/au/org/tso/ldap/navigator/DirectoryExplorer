package au.org.tso.ldap.navigator;

import java.util.Map;
import java.util.Set;
import java.util.Vector;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import java.util.Collection;
import java.util.HashMap;

import org.apache.directory.api.ldap.model.cursor.EntryCursor;
import org.apache.directory.api.ldap.model.entry.Entry;
import org.apache.directory.api.ldap.model.entry.Attribute;
import org.apache.directory.api.ldap.model.message.SearchScope;
import org.apache.directory.api.ldap.model.schema.AttributeType;
import org.apache.directory.api.ldap.model.schema.SchemaObjectWrapper;
import org.apache.directory.api.ldap.model.schema.registries.Schema;
import org.apache.directory.ldap.client.api.LdapConnection;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

@Component
public class DirectoryExplorer {

    @Autowired
    SchemaExplorer schemaExplorer;

    public DirectoryExplorer() {
    }

    private String bytesToHex(byte[] bytes) {
        StringBuilder sb = new StringBuilder();
        for (byte b : bytes) {
            sb.append(String.format("%02x", b));
        }

        return sb.toString();

    }

    private String getOid(Collection<Schema> schemas, String id) {
        for (Schema schema : schemas) {
            Set<SchemaObjectWrapper> content = schema.getContent();

            for (var attribute : content) {

                if (attribute.get() instanceof AttributeType attributeType) {
                    if (attributeType.getName().toLowerCase().equals(id.toLowerCase())) {

                        return attributeType.getOid();
                    }
                }

            }

        }

        return "";

    }

    private String getSyntaxOid(Collection<Schema> schemas, String id) {

        for (Schema schema : schemas) {
            Set<SchemaObjectWrapper> content = schema.getContent();

            for (var attribute : content) {

                if (attribute.get() instanceof AttributeType attributeType) {
                    if (attributeType.getName().toLowerCase().equals(id.toLowerCase())) {

                        return attributeType.getSyntaxOid().toString();
                    }

                }

            }

        }

        return "";

    }

    boolean isHumanReadable(String value) {
        Pattern pattern = Pattern.compile("[^\\p{ASCII}]", Pattern.CASE_INSENSITIVE);
        Matcher matcher = pattern.matcher(value);
        boolean matchFound = matcher.find();
        
        return (!matchFound);
    
    }

    Vector<String> search(LdapConnection connection, String dn) throws Exception {
        Vector<String> entries = new Vector<String>();

        try (EntryCursor cursor = connection.search(dn, "(objectclass=*)", SearchScope.OBJECT)) {

            for (Entry entry : cursor) {

                entries.add(entry.getDn().toString());

            }

        }

        try (EntryCursor cursor = connection.search(dn, "(objectclass=*)", SearchScope.ONELEVEL)) {

            for (Entry entry : cursor) {

                entries.add(entry.getDn().toString());

            }

        }

        return entries;

    }

    Vector<Map<String, String>> retrieve(LdapConnection connection, String dn) throws Exception {
        Vector<Map<String, String>> attributes = new Vector<Map<String, String>>();
        var logger = LoggerFactory.getLogger(DirectoryExplorer.class);

        Collection<Schema> schemas = schemaExplorer.load(connection);

        try {
            Entry entry = connection.lookup(dn);

            if (entry == null) {
                logger.info("Entry is NULL");

                return attributes;
            }

            for (Attribute attribute : entry.getAttributes()) {
                Map<String, String> properties = new HashMap<String, String>();
               
                properties.put("name", attribute.getUpId());
                properties.put("oid", getOid(schemas, attribute.getId()));
                properties.put("SyntaxOid", getSyntaxOid(schemas, attribute.getId()));
                properties.put("type", attribute.get().isHumanReadable() ? "String" : "Binary");

                if (isHumanReadable(attribute.get().getString())) {
                    properties.put("type", "String");
                    properties.put("value", attribute.get().getString());
      
                } else {
                    properties.put("type", "Binary");
                    properties.put("value", bytesToHex(attribute.get().getBytes()));
               
                }
   
                attributes.add(properties);

            }

            return attributes;

        } catch (Exception e) {
            logger.error("Search Error", e);
            return attributes;
        }

    }

}
